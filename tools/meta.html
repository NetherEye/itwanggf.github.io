<!DOCTYPE html>
<html>

<head>
  <script>
    window.onload = () => {
      initParameter()
      initCanvas()
    }

    function initParameter() {
      const {
        screen: {
          width
        },
        devicePixelRatio
      } = window
      this.windowWidth = width
      this.dpr = Math.round(devicePixelRatio)
    }

    async function initCanvas() {
      const canvas = document.getElementById('canvas')
      const ctx = canvas.getContext('2d')

      this.canvas = canvas
      this.ctx = ctx

      await getBackgroundImage()
      await getQRCodeImage()
      await getAvatarImage()

      this.fillBackgroundImage()
      this.fillQrCodeImage()
      this.fillUsernameText()
      this.fillHelpText()
      this.fillUserInfo()

    }

    function getBackgroundImage() {
      return new Promise(async (resolve) => {
        const backgroundImage = new Image()
        backgroundImage.src = await getURLBase64('http://cdn.algbb.cn/test/wechatbg.jpg')
        // backgroundImage.src = 'http://cdn.algbb.cn/test/wechatbg.jpg'
        backgroundImage.crossOrigin = '*'
        backgroundImage.onload = () => {
          this.backgroundImage = backgroundImage
          resolve()
        }
      })
    }

    function getQRCodeImage() {
      return new Promise(async (resolve) => {
        const qrCodeImage = new Image()
        qrCodeImage.src = await getURLBase64('http://cdn.algbb.cn/test/qrcode.jpg')
        // qrCodeImage.src = 'http://cdn.algbb.cn/test/qrcode.jpg'
        qrCodeImage.crossOrigin = '*'
        qrCodeImage.onload = () => {
          this.qrCodeImage = qrCodeImage
          resolve()
        }
      })
    }

    function getAvatarImage() {
      return new Promise(async (resolve) => {
        const avatarImage = new Image()
        avatarImage.src = await getURLBase64('http://cdn.algbb.cn/test/avatar.jpg')
        // avatarImage.src = 'http://cdn.algbb.cn/test/avatar.jpg'
        avatarImage.crossOrigin = '*'
        avatarImage.onload = () => {
          this.avatarImage = avatarImage
          resolve()
        }
      })
    }

    function fillBackgroundImage() {
      const {
        width,
        height
      } = this.backgroundImage

      // canvas宽度为手机宽度 - 40px
      const newCanvasWidth = this.windowWidth - 40
      const scale = width / newCanvasWidth
      const newCanvasHeight = height / scale

      this.canvas.width = newCanvasWidth * this.dpr
      this.canvas.height = newCanvasHeight * this.dpr
      this.canvas.style.width = (newCanvasWidth * this.dpr) + 'px'
      this.canvas.style.height = (newCanvasHeight * this.dpr) + 'px'
      this.ctx.scale(this.dpr, this.dpr)

      this.ctx.clearRect(0, 0, newCanvasWidth, newCanvasHeight)
      this.ctx.drawImage(this.backgroundImage, 0, 0, newCanvasWidth, newCanvasHeight)

      this.canvasWidth = newCanvasWidth
      this.canvasHeight = newCanvasHeight
    }

    function fillQrCodeImage() {
      const {
        width,
        height
      } = this.qrCodeImage
      const {
        canvasWidth,
        canvasHeight
      } = this

      // 设置二维码尺寸，默认正方形
      const qrCodeImageWidth = canvasWidth - 140
      const scale = width / qrCodeImageWidth
      const qrCodeImageHeight = height / scale

      // 设置渲染坐标
      const renderPointX = canvasWidth / 2 - qrCodeImageWidth / 2
      const renderPointY = canvasHeight / 2 - qrCodeImageHeight / 2 - 30

      this.qrCodePointX = renderPointX
      this.qrCodePointY = renderPointY
      this.qrCodeImageWidth = qrCodeImageWidth
      this.qrCodeImageHeight = qrCodeImageHeight

      this.ctx.drawImage(this.qrCodeImage, renderPointX, renderPointY, qrCodeImageWidth, qrCodeImageHeight)
    }

    function fillUsernameText() {
      const {
        canvasWidth
      } = this

      this.ctx.font = 'normal 20px 微软雅黑'
      this.ctx.fillStyle = '#666'
      this.ctx.textAlign = 'center'
      this.ctx.textBaseline = 'middle'

      this.ctx.fillText('zhcxk1998', canvasWidth / 2, this.qrCodePointY - 20)
    }

    function fillHelpText() {
      const {
        canvasWidth
      } = this

      this.ctx.font = 'normal 16px 微软雅黑'
      this.ctx.fillStyle = '#999'
      this.ctx.textAlign = 'center'
      this.ctx.textBaseline = 'middle'
      this.ctx.fillText('微信扫描上方二维码，添加好友', canvasWidth / 2, this.qrCodePointY + this.qrCodeImageHeight + 80)
    }

    function fillUserInfo() {
      const userName = 'BB小天使'
      const {
        canvasWidth
      } = this
      const {
        width,
        height
      } = this.avatarImage
      const {
        width: textWidth
      } = this.ctx.measureText(userName)

      // 设置头像大小，默认头像为正方形，30 * 30
      const avatarWidth = 30
      const scale = width / avatarWidth
      const avatarHeight = height / scale

      // 设置用户名与头像的间隔
      const cap = 10
      // 计算出头像与名字组合的宽度
      const composeWidth = avatarWidth + textWidth + cap

      // 配置渲染的横纵坐标
      const renderPointX = canvasWidth / 2 - composeWidth / 2
      const renderPointY = this.qrCodePointY + this.qrCodeImageHeight + 100

      // 设置回左对齐，不然与头像与名字排列会乱
      this.ctx.textAlign = 'left'

      // 渲染
      this.ctx.fillText(userName, renderPointX + avatarWidth + cap, renderPointY + avatarHeight / 2)
      this.ctx.drawImage(this.avatarImage, renderPointX, renderPointY, avatarWidth, avatarHeight)
    }

    function saveImage() {
      const {
        canvasWidth,
        canvasHeight
      } = this

      console.log(this.canvas.toDataURL())
    }

    function getURLBase64(url) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest()
        xhr.open('get', url, true)
        xhr.responseType = 'blob'
        xhr.onload = function () {
          if (this.status === 200) {
            const blob = this.response
            const fileReader = new FileReader()
            fileReader.onloadend = function (e) {
              const {
                target
              } = e
              const result = target.result
              resolve(result)
            }
            fileReader.readAsDataURL(blob)
          }
        }
        xhr.onerror = function () {
          reject()
        }
        xhr.send()
      })
    }
  </script>
  <style>
  </style>
</head>

<body>
  <div class="container">
    <canvas id="canvas" onclick="saveImage()"></canvas>
  </div>
</body>

</html>
